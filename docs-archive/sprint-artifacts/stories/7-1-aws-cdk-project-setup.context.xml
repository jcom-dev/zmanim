<story-context id="epic-7/story-7-1" v="1.0">
  <metadata>
    <epicId>7</epicId>
    <storyId>7.1</storyId>
    <title>AWS CDK Project Setup</title>
    <status>drafted</status>
    <generatedAt>2025-12-10</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/stories/7-1-aws-cdk-project-setup.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>AWS CDK infrastructure as code</iWant>
    <soThat>I can reproducibly deploy and manage AWS resources for the production migration</soThat>
    <tasks>
      <task id="1" name="Initialize CDK Project" ac="1">
        <subtask>1.1 Create `/infrastructure` directory in project root</subtask>
        <subtask>1.2 Run `npx cdk init app --language typescript` in infrastructure directory</subtask>
        <subtask>1.3 Configure `tsconfig.json` for strict TypeScript</subtask>
        <subtask>1.4 Add `.gitignore` entries for CDK artifacts (`cdk.out/`, `*.d.ts`, `*.js`)</subtask>
        <subtask>1.5 Add `cdk.json` with app entry point and context</subtask>
      </task>
      <task id="2" name="Create Stack Structure" ac="2">
        <subtask>2.1 Create `lib/network-stack.ts` with placeholder VPC construct</subtask>
        <subtask>2.2 Create `lib/compute-stack.ts` with placeholder EC2 construct</subtask>
        <subtask>2.3 Create `lib/cdn-stack.ts` with placeholder CloudFront construct</subtask>
        <subtask>2.4 Create `lib/dns-stack.ts` with placeholder Route53 construct</subtask>
        <subtask>2.5 Update `bin/infrastructure.ts` to instantiate all stacks</subtask>
        <subtask>2.6 Configure stack dependencies (CDN depends on Compute, etc.)</subtask>
      </task>
      <task id="3" name="Environment Configuration" ac="3">
        <subtask>3.1 Create `lib/config.ts` with environment-specific settings</subtask>
        <subtask>3.2 Define `prod` environment config (eu-west-1, zmanim.shtetl.io domain)</subtask>
        <subtask>3.3 Add environment parameter to stack constructors</subtask>
        <subtask>3.4 Document that dev environment stays on Fly.io (no CDK deployment)</subtask>
      </task>
      <task id="4" name="GitHub Actions Workflow" ac="4,5">
        <subtask>4.1 Create `.github/workflows/cdk-deploy.yml`</subtask>
        <subtask>4.2 Configure trigger on tag push (`v*`)</subtask>
        <subtask>4.3 Add AWS credentials from GitHub Secrets</subtask>
        <subtask>4.4 Install CDK dependencies (`npm ci`)</subtask>
        <subtask>4.5 Run `cdk synth` to validate templates</subtask>
        <subtask>4.6 Run `cdk deploy --all --require-approval never` for prod</subtask>
        <subtask>4.7 Document required GitHub Secrets: `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`</subtask>
      </task>
      <task id="5" name="Verification and Testing" ac="1-5">
        <subtask>5.1 Run `cdk synth` locally to verify CloudFormation output</subtask>
        <subtask>5.2 Run `cdk diff` to show expected changes (empty on first run)</subtask>
        <subtask>5.3 Verify GitHub Actions workflow syntax with `act` or manual review</subtask>
        <subtask>5.4 Document IAM permissions required for CDK deployment</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">CDK project initialized in `/infrastructure` with TypeScript</criterion>
    <criterion id="AC2">Stacks defined: NetworkStack, ComputeStack, CDNStack, DNSStack</criterion>
    <criterion id="AC3">Environment config supports prod (dev stays on Fly.io)</criterion>
    <criterion id="AC4">GitHub Actions workflow deploys CDK on tag push</criterion>
    <criterion id="AC5">AWS credentials configured in GitHub Secrets</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc type="epic" path="docs/sprint-artifacts/epic-7-aws-migration.md">
        Epic 7 AWS Migration - Full architecture, cost breakdown ($44/mo target),
        single EC2 m7g.medium in eu-west-1, Packer AMI strategy, CloudFront CDN
      </doc>
      <doc type="tech-spec" path="docs/sprint-artifacts/tech-spec-epic-7.md">
        Authoritative acceptance criteria, detailed design for all 10 stories,
        test strategy, security requirements, deployment architecture
      </doc>
      <doc type="architecture" path="docs/architecture.md">
        Existing system architecture - Go 1.24+ API, Next.js 16 frontend,
        PostgreSQL+PostGIS, Redis, Clerk auth
      </doc>
      <doc type="coding-standards" path="docs/coding-standards.md">
        CAST-IRON rules for development - security, patterns, testing standards
      </doc>
    </docs>

    <code>
      <existing>
        <note>No existing CDK/infrastructure code - this is a greenfield infrastructure setup</note>
        <relevantFiles>
          <file path=".github/workflows/ci.yml">Existing CI workflow pattern - Node 20, Go 1.24, golangci-lint</file>
          <file path=".github/workflows/deploy-api.yml">Current Fly.io deployment - will be replaced by CDK</file>
        </relevantFiles>
      </existing>
      <toCreate>
        <file path="infrastructure/bin/infrastructure.ts">CDK app entry point - instantiate all stacks</file>
        <file path="infrastructure/lib/config.ts">Environment config (prod: eu-west-1)</file>
        <file path="infrastructure/lib/network-stack.ts">VPC, public subnet, security groups</file>
        <file path="infrastructure/lib/compute-stack.ts">EC2, EBS, IAM roles</file>
        <file path="infrastructure/lib/cdn-stack.ts">CloudFront, API Gateway</file>
        <file path="infrastructure/lib/dns-stack.ts">Route53, ACM certificates</file>
        <file path="infrastructure/cdk.json">CDK configuration</file>
        <file path="infrastructure/package.json">CDK dependencies</file>
        <file path="infrastructure/tsconfig.json">TypeScript config (strict mode)</file>
        <file path=".github/workflows/cdk-deploy.yml">CDK deployment workflow</file>
      </toCreate>
    </code>

    <dependencies>
      <cdkDependencies>
        <package name="aws-cdk-lib" version="^2.x">Core CDK v2 library (single package)</package>
        <package name="constructs" version="^10.x">CDK constructs base</package>
        <package name="typescript" version="^5.4.0">TypeScript compiler</package>
        <package name="ts-node" version="^10.x">TypeScript execution for CDK</package>
        <package name="@types/node" version="^20.x">Node.js type definitions</package>
      </cdkDependencies>
      <awsServices>
        <service name="VPC">Virtual Private Cloud - public subnet only (no NAT)</service>
        <service name="EC2">Elastic Compute Cloud - m7g.medium Graviton3</service>
        <service name="EBS">Elastic Block Store - root + data volumes</service>
        <service name="CloudFront">CDN with Origin Shield</service>
        <service name="API Gateway">HTTP API (not REST) for lower latency</service>
        <service name="Route53">DNS management</service>
        <service name="ACM">SSL certificates (us-east-1 for CloudFront)</service>
        <service name="S3">Static assets + backups</service>
        <service name="SSM Parameter Store">Secrets management (free tier)</service>
        <service name="IAM">Identity and access management</service>
      </awsServices>
      <existingProjectDeps>
        <backend>Go 1.24+, Chi router, pgx, SQLc, Clerk SDK</backend>
        <frontend>Next.js 16, React 19, Tailwind, shadcn/ui, Clerk</frontend>
        <database>PostgreSQL 16 + PostGIS</database>
        <cache>Redis 7</cache>
      </existingProjectDeps>
    </dependencies>
  </artifacts>

  <constraints>
    <architectural>
      <constraint priority="critical">Region MUST be eu-west-1 (Ireland) for US+Israel latency balance</constraint>
      <constraint priority="critical">CDK v2 ONLY (aws-cdk-lib single package) - NOT CDK v1</constraint>
      <constraint priority="critical">Production environment only - dev stays on Fly.io/Vercel</constraint>
      <constraint priority="high">Stack naming: Zmanim{StackName}Prod pattern</constraint>
      <constraint priority="high">TypeScript strict mode enabled</constraint>
    </architectural>
    <security>
      <constraint priority="critical">NEVER commit AWS credentials to repository</constraint>
      <constraint priority="critical">Use GitHub Secrets for AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY</constraint>
      <constraint priority="high">IAM least privilege - document required permissions</constraint>
    </security>
    <cost>
      <constraint priority="high">Target ~$44/month total infrastructure cost</constraint>
      <constraint priority="high">No NAT Gateway ($32/month savings)</constraint>
      <constraint priority="medium">Use Graviton3 (ARM) for cost efficiency</constraint>
    </cost>
    <stackDependencies>
      <dependency>NetworkStack has no dependencies (base layer)</dependency>
      <dependency>ComputeStack depends on NetworkStack (VPC/subnets)</dependency>
      <dependency>CDNStack depends on ComputeStack (API Gateway origin)</dependency>
      <dependency>DNSStack depends on CDNStack (CloudFront distribution)</dependency>
    </stackDependencies>
  </constraints>

  <interfaces>
    <stackOutputs>
      <output stack="NetworkStack" name="VpcId">VPC identifier for compute stack</output>
      <output stack="NetworkStack" name="PublicSubnetId">Public subnet for EC2</output>
      <output stack="NetworkStack" name="SecurityGroupId">Security group for EC2</output>
      <output stack="ComputeStack" name="InstanceId">EC2 instance ID</output>
      <output stack="ComputeStack" name="ElasticIp">Public IP for API Gateway</output>
      <output stack="CDNStack" name="DistributionId">CloudFront distribution ID</output>
      <output stack="CDNStack" name="DistributionDomain">CloudFront domain name</output>
      <output stack="DNSStack" name="CertificateArn">ACM certificate ARN</output>
    </stackOutputs>
    <githubWorkflow>
      <trigger>Tag push matching `v*` pattern</trigger>
      <secrets>
        <secret name="AWS_ACCESS_KEY_ID">AWS IAM user access key</secret>
        <secret name="AWS_SECRET_ACCESS_KEY">AWS IAM user secret key</secret>
      </secrets>
      <steps>
        <step>Checkout code</step>
        <step>Setup Node.js 20</step>
        <step>npm ci (install CDK deps)</step>
        <step>cdk synth (validate CloudFormation)</step>
        <step>cdk deploy --all --require-approval never</step>
      </steps>
    </githubWorkflow>
  </interfaces>

  <tests>
    <standards>
      <standard source="coding-standards.md">
        CI/CD: Test ALL changes locally BEFORE committing - no push-and-wait cycles
      </standard>
      <standard source="coding-standards.md">
        Security: No secrets, passwords, or credentials committed - use environment variables
      </standard>
      <standard source="tech-spec-epic-7.md">
        CDK synth MUST produce valid CloudFormation templates
      </standard>
      <standard source="tech-spec-epic-7.md">
        GitHub Actions workflow MUST pass syntax validation
      </standard>
    </standards>
    <locations>
      <location path="infrastructure/">CDK project root - run `cdk synth` and `cdk diff`</location>
      <location path=".github/workflows/cdk-deploy.yml">Workflow syntax - validate with `act` or manual review</location>
    </locations>
    <ideas>
      <testIdea type="unit">CDK synth produces valid CloudFormation for each stack</testIdea>
      <testIdea type="unit">Stack dependencies are correctly configured (no circular deps)</testIdea>
      <testIdea type="unit">Environment config correctly sets region to eu-west-1</testIdea>
      <testIdea type="integration">GitHub Actions workflow executes without errors (dry-run)</testIdea>
      <testIdea type="validation">cdk diff shows expected resources for each stack</testIdea>
      <testIdea type="security">No hardcoded credentials in any CDK files</testIdea>
      <testIdea type="security">IAM permissions documented and follow least privilege</testIdea>
    </ideas>
  </tests>
</story-context>
